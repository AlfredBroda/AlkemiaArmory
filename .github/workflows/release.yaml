name: GitHub Release

on:
    # Triggers the workflow on pushing a tag only
    push:
        tags: "*"
        branches:
            - "!*"

    # Allows you to run this workflow manually from the Actions tab
    workflow_dispatch:

jobs:
    build:
        # The type of runner that the job will run on
        runs-on: ubuntu-latest

        steps:
            # Checks-out repository under $GITHUB_WORKSPACE, so your job can access it
            # GitHub Actions by default doesn't check out tags, so make sure those are included
            - name: Checkout
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - name: Set up JDK 11
              uses: actions/setup-java@v3
              with:
                  java-version: "11"
                  distribution: "adopt"

            - name: Validate Gradle wrapper
              uses: gradle/wrapper-validation-action@e6e38bacfdf1a337459f332974bb2327a31aaf4b

            - name: Set Variables
              run: |
                  echo "VERSION=$(git describe --tags)" >> $GITHUB_ENV
                  git log --format=%B -n 1 $(git log -1 --pretty=format:"%h") | cat - > changes.txt

            - name: Create Mod Zipfile
              uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1
              with:
                  arguments: build release

            - name: Publish Release on GitHub
              uses: "ncipollo/release-action@v1"
              with:
                  name: ${{ env.VERSION }}
                  tag: ${{ env.VERSION }}
                  bodyFile: changes.txt
                  draft: true
                  prerelease: false
                  token: ${{ secrets.GITHUB_TOKEN }}
                  artifacts: "alkemia-armoury-*.zip"
